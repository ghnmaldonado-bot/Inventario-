<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surtido Maestro - Blaebuck Files v34.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: bold; }
        #reader, #reader-db { width: 100%; border-radius: 12px; overflow: hidden; background: #000; margin-top: 10px; display: none; min-height: 250px; }
        .modal-overlay { background: rgba(0,0,0,0.8); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 60; max-height: 300px; overflow-y: auto; border-radius: 8px; margin-top: 5px; border: 1px solid #e5e7eb; }
        .dropdown-content button { width: 100%; text-align: left; padding: 10px; border-bottom: 1px solid #f3f4f6; font-size: 11px; text-transform: uppercase; font-weight: bold; }
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 1000; flex-direction: column; align-items:center; justify-content:center; }
    </style>
</head>
<body class="p-4">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mb-2"></div>
        <span class="text-[10px] font-black text-blue-900">SINCRONIZANDO CON LA NUBE...</span>
    </div>

    <div id="modalConfirmar" class="modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl border-2 border-blue-900">
            <div id="modalHeader" class="bg-blue-900 p-4 text-white flex justify-between items-center">
                <h3 id="modalTitle" class="font-black uppercase text-xs italic">Detalle de Producto</h3>
                <span id="modalPrecioTag" class="bg-green-600 text-white px-2 py-1 rounded text-[10px] font-bold"></span>
            </div>
            <div class="p-5">
                <div id="modalFicha" class="mb-4 border-b pb-4 text-sm font-bold text-blue-900 uppercase"></div>
                <div id="controlesSurtido">
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Empaque</label>
                            <select id="modalTipoCaja" onchange="recalcularUnidadesModal()" class="w-full p-2 border rounded font-bold text-blue-700">
                                <option value="0">Caja x 0</option><option value="1">Caja x 1</option><option value="6">Caja x 6</option><option value="12">Caja x 12</option><option value="24">Caja x 24</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Cant. Cajas</label>
                            <input id="modalCantCajas" type="number" oninput="recalcularUnidadesModal()" class="w-full p-2 border rounded font-bold text-center text-blue-600" value="0">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-orange-500 uppercase italic">Unidades Finales</label>
                        <input id="modalUnidadesFinal" type="number" class="w-full p-3 border-2 border-orange-200 rounded-lg font-black text-center text-xl text-orange-600" value="0">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="cerrarModal()" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold uppercase text-[10px]">Cerrar</button>
                    <button id="btnAccionModal" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold uppercase text-[10px]">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto">
        <div class="flex justify-around mb-4 bg-white rounded-lg p-2 shadow-sm sticky top-0 z-50">
            <button onclick="switchTab('surtido')" id="btn-surtido" class="tab-active py-2 px-4 text-sm uppercase">Surtido</button>
            <button onclick="switchTab('precios')" id="btn-precios" class="py-2 px-4 text-gray-500 text-sm uppercase">Cat√°logo</button>
            <button onclick="switchTab('historial')" id="btn-historial" class="py-2 px-4 text-gray-500 text-sm uppercase">Historial</button>
        </div>

        <div id="tab-surtido">
            <div class="card p-4 mb-4 border border-blue-100 grid grid-cols-2 gap-2">
                <div><label class="text-[9px] font-black text-blue-900 uppercase">Surtidor</label><input id="nombreSurtidor" type="text" class="w-full p-2 border rounded text-xs font-bold uppercase" oninput="guardarPerfil()"></div>
                <div><label class="text-[9px] font-black text-blue-900 uppercase">Almac√©n</label><input id="nombreAlmacen" type="text" class="w-full p-2 border rounded text-xs font-bold uppercase" oninput="guardarPerfil()"></div>
            </div>
            
            <div class="card p-4 mb-4 border border-blue-200">
                <button onclick="toggleScanner('surtido')" id="btn-scanner" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold uppercase text-xs">üì∏ C√°mara Surtido</button>
                <div id="reader"></div>
            </div>

            <div class="card p-5 mb-6 relative">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[9px] font-black text-blue-900 uppercase italic">Buscador Maestro</label>
                    <button onclick="sincronizarConNube()" class="text-blue-600 font-black text-[10px] uppercase italic animate-pulse">üîÑ Actualizar Nube</button>
                </div>
                <div class="flex gap-1">
                    <input id="ref" type="text" placeholder="REF / PLU / EAN" oninput="busquedaDinamica()" class="flex-1 p-2 rounded-lg bg-blue-50 font-bold border border-blue-100 uppercase">
                    <button onclick="forzarBusquedaLupa()" class="bg-blue-600 text-white p-2 rounded-lg">üîé</button>
                </div>
            </div>

            <div class="card overflow-hidden mb-4">
                <div class="bg-gray-800 text-white p-2 flex justify-between items-center text-[8px] uppercase font-bold">
                    <span>Lista de Surtido</span>
                    <button onclick="vaciarTodo()" class="bg-red-700 px-2 py-1 rounded italic text-[7px]">üóëÔ∏è Vaciar</button>
                </div>
                <table class="w-full text-[11px] text-left">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-[8px]">
                        <tr><th class="p-2">Art√≠culo</th><th class="p-2 text-center">Caj</th><th class="p-2 text-center">U.Tot</th><th class="p-2"></th></tr>
                    </thead>
                    <tbody id="listaSurtido" class="divide-y divide-gray-100"></tbody>
                    <tfoot class="bg-blue-900 text-white font-black italic">
                        <tr><td colspan="2" class="p-3 text-right text-[10px]">TOTAL:</td><td id="granTotal" class="p-3 text-center text-lg">0</td><td></td></tr>
                    </tfoot>
                </table>
            </div>

            <div class="card p-4 mb-10 border border-green-200">
                <input id="fechaPicking" type="date" class="w-full p-2 border rounded font-bold text-blue-900 mb-2">
                <button onclick="finalizarDia()" class="w-full p-3 bg-green-600 text-white rounded-lg text-[11px] font-bold uppercase">üíæ Guardar en Historial</button>
            </div>
        </div>

        <div id="tab-precios" class="hidden">
            <div class="card p-4 mb-4 border border-green-200">
                <button onclick="toggleScanner('catalogo')" class="w-full bg-green-700 text-white py-2 rounded-lg font-bold uppercase text-xs">üì∏ C√°mara Cat√°logo</button>
                <div id="reader-db"></div>
            </div>
            <div class="card p-4 mb-4 bg-green-50 border border-green-200">
                <h3 class="font-black text-green-800 text-[10px] uppercase mb-2 italic">Registro de Productos</h3>
                <div class="grid grid-cols-1 gap-2">
                    <input id="db-ref" type="text" placeholder="C√≥digo / EAN" class="p-2 rounded border font-bold uppercase">
                    <input id="db-desc" type="text" placeholder="Nombre" class="p-2 rounded border uppercase font-bold">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="db-plu" type="text" placeholder="PLU" class="p-2 rounded border font-bold">
                        <input id="db-marca" type="text" placeholder="Marca" class="p-2 rounded border uppercase font-bold">
                    </div>
                    <input id="db-precio" type="number" placeholder="Precio $" class="p-2 rounded border font-bold text-green-700">
                    <button onclick="guardarEnCatalogo()" class="bg-green-700 text-white p-3 rounded font-bold uppercase">Guardar en Base de Datos</button>
                </div>
            </div>
            <div id="db-lista" class="card p-2 divide-y divide-gray-100 text-[10px] max-h-60 overflow-y-auto"></div>
        </div>

        <div id="tab-historial" class="hidden">
            <div class="card p-4 mb-4 bg-blue-50 border border-blue-200">
                <h2 class="font-black text-blue-900 text-[10px] uppercase mb-3 italic">Reportes Guardados</h2>
                <div id="listaHistorial" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // CAMBIA ESTO POR TU URL REAL DE GOOGLE APP SCRIPT
        const URL_GOOGLE = "https://script.google.com/macros/s/AKfycbxNj_qkhubhEUJHZtOZOzI23iTxnxBwzfjlBmneNAdmCb0YcKd3RL6xWZ3Ei1B9UgW5Cg/exec";

        let registros = JSON.parse(localStorage.getItem('surtido_v21_final')) || [];
        let catalogo = JSON.parse(localStorage.getItem('catalogo_db')) || {};
        let historial = JSON.parse(localStorage.getItem('historial_picking_v2')) || [];
        let perfil = JSON.parse(localStorage.getItem('perfil_blaebuck')) || { surtidor: '', almacen: '' };
        
        let html5QrCode = null; let pEscaneado = null;
        const formatMoney = (v) => v ? parseInt(v).toLocaleString('de-DE') + " $" : "0 $";

        // ENV√çO CORREGIDO PARA GITHUB (JSONP / NO-CORS)
        async function enviarANube(datos) {
            const params = new URLSearchParams(datos);
            try {
                fetch(`${URL_GOOGLE}?${params.toString()}`, { mode: 'no-cors' });
                console.log("Enviado a Google Sheets");
            } catch (e) { console.error("Error de red"); }
        }

        async function sincronizarConNube() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const response = await fetch(URL_GOOGLE + "?action=getCatalog");
                const data = await response.json();
                if (data) {
                    catalogo = data;
                    localStorage.setItem('catalogo_db', JSON.stringify(catalogo));
                    renderizarCatalogo();
                    alert("¬°Sincronizaci√≥n Exitosa!");
                }
            } catch (error) { alert("Error al descargar cat√°logo. Verifica conexi√≥n."); }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function switchTab(t) {
            detenerEscaner();
            document.getElementById('tab-surtido').classList.toggle('hidden', t !== 'surtido');
            document.getElementById('tab-precios').classList.toggle('hidden', t !== 'precios');
            document.getElementById('tab-historial').classList.toggle('hidden', t !== 'historial');
            if(t === 'historial') renderizarHistorial();
        }

        function busquedaDinamica() {
            const v = document.getElementById('ref').value.trim();
            if (v.length >= 4) {
                let e = Object.keys(catalogo).find(k => k === v || k.endsWith(v));
                if (e) { pEscaneado = { ref: e, ...catalogo[e] }; abrirFicha(); document.getElementById('ref').value = ""; }
            }
        }

        function forzarBusquedaLupa() {
            const v = document.getElementById('ref').value.trim();
            if(!v) return;
            let e = Object.keys(catalogo).find(k => k === v || k.endsWith(v) || (catalogo[k] && catalogo[k].plu === v));
            if (e) { pEscaneado = { ref: e, ...catalogo[e] }; abrirFicha(); }
            else { alert("No existe en cat√°logo."); }
        }

        function abrirFicha() {
            document.getElementById('modalPrecioTag').innerText = formatMoney(pEscaneado.precio);
            document.getElementById('modalFicha').innerHTML = `
                <div class="text-lg font-black text-blue-900 leading-tight">${pEscaneado.desc}</div>
                <div class="text-[10px] font-bold text-gray-400 uppercase italic">PLU: ${pEscaneado.plu} | REF: ${pEscaneado.ref.slice(-4)}</div>`;
            document.getElementById('modalConfirmar').style.display = 'flex';
            document.getElementById('btnAccionModal').onclick = guardarPicking;
        }

        function guardarPicking() { 
            const u = parseInt(document.getElementById('modalUnidadesFinal').value) || 0; 
            const f = parseInt(document.getElementById('modalTipoCaja').value);
            const c = (f === 0) ? 0 : (parseInt(document.getElementById('modalCantCajas').value) || 0); 
            
            if(u <= 0) return alert("Cantidad inv√°lida");

            const item = { ...pEscaneado, totalCajas: c, unidadesDeCajas: u };
            registros.push(item); 
            
            // Env√≠o a Google en tiempo real
            enviarANube({
                surtidor: perfil.surtidor,
                almacen: perfil.almacen,
                producto: item.desc,
                plu: item.plu,
                cantidad: u
            });

            renderizar(); cerrarModal(); 
        }

        function renderizar() { 
            const l = document.getElementById('listaSurtido'); l.innerHTML = ''; let t = 0; 
            registros.forEach((item, i) => { 
                t += item.unidadesDeCajas; 
                l.innerHTML += `<tr class="border-b"><td class="p-2"><b>${item.desc}</b><br><span class="text-[9px] text-blue-600">REF ${item.ref.slice(-4)}</span></td><td class="p-2 text-center text-gray-400">${item.totalCajas}</td><td class="p-2 text-center font-bold bg-blue-50">${item.unidadesDeCajas}</td><td class="p-2"><button onclick="borrarItem(${i})">‚ùå</button></td></tr>`; 
            }); 
            document.getElementById('granTotal').innerText = t; 
            localStorage.setItem('surtido_v21_final', JSON.stringify(registros)); 
        }

        function finalizarDia() {
            if(registros.length === 0) return alert("Lista vac√≠a");
            const f = document.getElementById('fechaPicking').value;
            historial.unshift({ fecha: f, total: document.getElementById('granTotal').innerText, items: [...registros], almacen: perfil.almacen });
            localStorage.setItem('historial_picking_v2', JSON.stringify(historial));
            registros = []; renderizar(); alert("Reporte guardado localmente");
        }

        function renderizarHistorial() { 
            const l = document.getElementById('listaHistorial'); l.innerHTML = ''; 
            historial.forEach((h, i) => { 
                l.innerHTML += `<div class="p-3 bg-white rounded-lg border-l-4 border-blue-900 flex justify-between items-center">
                    <div><b>${h.fecha}</b> - ${h.almacen}<br><span class="text-blue-700">${h.total} UNIDADES</span></div>
                    <button onclick="generarPDF(${i})" class="bg-gray-100 p-2 rounded">üìÑ PDF</button>
                </div>`; 
            }); 
        }

        function generarPDF(idx) { 
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); 
            const h = historial[idx];
            doc.text(`REPORTE DE SURTIDO - ${h.almacen}`, 10, 10);
            doc.autoTable({
                startY: 20,
                head: [['ART√çCULO', 'PLU', 'CANT']],
                body: h.items.map(it => [it.desc, it.plu, it.unidadesDeCajas])
            });
            doc.save(`Reporte_${h.fecha}.pdf`);
        }

        async function guardarEnCatalogo() { 
            const r = document.getElementById('db-ref').value.trim();
            const p = { 
                desc: document.getElementById('db-desc').value.toUpperCase(), 
                plu: document.getElementById('db-plu').value, 
                marca: document.getElementById('db-marca').value.toUpperCase(), 
                precio: document.getElementById('db-precio').value 
            };
            catalogo[r] = p;
            localStorage.setItem('catalogo_db', JSON.stringify(catalogo));
            
            // Sincronizar nuevo producto con la nube
            enviarANube({ action: 'addCatalog', ref: r, ...p });
            
            renderizarCatalogo(); alert("Producto Registrado");
        }

        function renderizarCatalogo() { 
            const l = document.getElementById('db-lista'); l.innerHTML = ''; 
            for(let r in catalogo) { l.innerHTML += `<div class="p-2 border-b uppercase">${catalogo[r].desc} <span class="text-blue-500">[${r}]</span></div>`; } 
        }

        async function detenerEscaner() { if (html5QrCode) { try { await html5QrCode.stop(); } catch(e){} html5QrCode = null; } document.querySelectorAll('[id^="reader"]').forEach(el => el.style.display = 'none'); }
        async function toggleScanner(tipo) { 
            const rid = (tipo === 'surtido' ? 'reader' : 'reader-db'); 
            if (document.getElementById(rid).style.display === 'none') { 
                await detenerEscaner(); document.getElementById(rid).style.display = 'block'; 
                html5QrCode = new Html5Qrcode(rid); 
                html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => { 
                    if(tipo === 'surtido') { document.getElementById('ref').value = text; forzarBusquedaLupa(); }
                    else { document.getElementById('db-ref').value = text; }
                    detenerEscaner(); 
                }).catch(e => alert("Error de c√°mara: Aseg√∫rate de dar permisos HTTPS."));
            } else { detenerEscaner(); } 
        }

        function recalcularUnidadesModal() { const f = parseInt(document.getElementById('modalTipoCaja').value); const c = parseInt(document.getElementById('modalCantCajas').value) || 0; document.getElementById('modalUnidadesFinal').value = (f === 0 ? c : c * f); }
        function cerrarModal() { document.getElementById('modalConfirmar').style.display = 'none'; }
        function borrarItem(i) { registros.splice(i,1); renderizar(); }
        function vaciarTodo() { if(confirm("¬øLimpiar lista?")){ registros = []; renderizar(); } }
        function guardarPerfil() { perfil.surtidor = document.getElementById('nombreSurtidor').value; perfil.almacen = document.getElementById('nombreAlmacen').v
